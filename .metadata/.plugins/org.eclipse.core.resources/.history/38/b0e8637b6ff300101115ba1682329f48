package com.orderservice.service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.orderservice.Exception.ApiResponse;
import com.orderservice.Exception.OrderValidationException;
import com.orderservice.Repository.OrderRepository;
import com.orderservice.dto.CartResponse;
import com.orderservice.dto.InventoryCheckRequestDTO;
import com.orderservice.dto.InventoryCheckResponseDTO;
import com.orderservice.dto.InventoryReduceRequestDTO;
import com.orderservice.dto.OrderItemErrorDTO;
import com.orderservice.dto.OrderItemResponse;
import com.orderservice.dto.OrderResponse;
import com.orderservice.dto.ProductResponse;
import com.orderservice.dto.UserResponse;
import com.orderservice.entity.Order;
import com.orderservice.entity.OrderItem;

@Service
public class OrderService {
    
	private final UserClient userclient;
	private final OrderRepository orderRepository;
	public OrderService (UserClient userclient,OrderRepository orderRepository) {
		this.userclient=userclient;
		this.orderRepository=orderRepository;
	}
	public ApiResponse<List<OrderItemErrorDTO>> checkInventory(Long userId) {

	    UserResponse user = userclient.getUserById(userId);
	    List<CartResponse> cartItems = user.getCartItems();

	    List<InventoryCheckRequestDTO> checkRequests =
	            cartItems.stream()
	                .map(c -> {
	                    InventoryCheckRequestDTO dto = new InventoryCheckRequestDTO();
	                    dto.setProductId(c.getProductId());
	                    dto.setRequiredQuantity(c.getQuantity());
	                    return dto;
	                }).toList();

	    List<InventoryCheckResponseDTO> responses =
	            userclient.checkStock(checkRequests);

	    List<OrderItemErrorDTO> errors = responses.stream()
	            .filter(r -> !r.getAvailable())
	            .map(r -> {
	                OrderItemErrorDTO err = new OrderItemErrorDTO();
	                err.setProductId(r.getProductId());
	                err.setReason(r.getMessage());
	                err.setAvailableQuantity(r.getAvailableQuantity());
	                return err;
	            }).toList();

	    ApiResponse<List<OrderItemErrorDTO>> response = new ApiResponse<>();

	    if (!errors.isEmpty()) {
	        response.setSuccess(false);
	        response.setStatus("STOCK_FAILED");
	        response.setMessage("Some items are out of stock");
	        response.setData(errors);
	        return response;
	    }

	    response.setSuccess(true);
	    response.setStatus("STOCK_OK");
	    response.setMessage("All items available");
	    response.setData(List.of());
	    return response;
	}
	public ApiResponse<OrderResponse> createOrder(Long userId) {

	    UserResponse user = userclient.getUserById(userId);
	    List<CartResponse> cartItems = user.getCartItems();

	    Order order = new Order();
	    order.setUserId(userId);
	    order.setAddress(user.getAddress());
	    order.setOrderDate(LocalDate.now());
	    order.setDeliveryDate(LocalDate.now().plusDays(2));
	    order.updateStatusBasedOnDate();

	    List<OrderItem> orderItems = new ArrayList<>();
	    BigDecimal totalAmount = BigDecimal.ZERO;

	    for (CartResponse cart : cartItems) {
	        ProductResponse product =
	                userclient.getProductById(cart.getProductId());

	        OrderItem item = new OrderItem();
	        item.setProductId(cart.getProductId());
	        item.setProductName(product.getName());
	        item.setPrice(product.getPrice());
	        item.setQuantity(cart.getQuantity());
	        item.setOrder(order);

	        orderItems.add(item);
	        totalAmount = totalAmount.add(
	                product.getPrice()
	                       .multiply(BigDecimal.valueOf(cart.getQuantity())));
	    }

	    order.setOrderItems(orderItems);
	    order.setTotalAmount(totalAmount.doubleValue());

	    Order savedOrder = orderRepository.save(order);

	    // reduce stock
	    List<InventoryReduceRequestDTO> reduceRequests =
	            cartItems.stream()
	                .map(c -> new InventoryReduceRequestDTO(
	                        c.getProductId(), c.getQuantity()))
	                .toList();

	    userclient.reduceStock(reduceRequests);

	    userclient.deleteCartItem(userId);

	    ApiResponse<OrderResponse> response = new ApiResponse<>();
	    response.setSuccess(true);
	    response.setStatus("ORDER_CREATED");
	    response.setMessage("Order placed successfully");
	    response.setData(mapToOrderResponse(savedOrder));

	    return response;
	}

	private OrderResponse mapToOrderResponse(Order order) {
       OrderResponse orderResponse=new OrderResponse();
		orderResponse.setDeliveryDate(order.getDeliveryDate());
		orderResponse.setOrderDate(order.getOrderDate());
		orderResponse.setAddress(order.getAddress());
		orderResponse.setStatus(order.getOrderStatus());
		orderResponse.setOrderId(order.getId());
		orderResponse.setTotalAmount(order.getTotalAmount());
		orderResponse.setUserId(order.getUserId());
		List<OrderItemResponse> itemResponses =
		        order.getOrderItems() == null
		        ? new ArrayList<>()
		        : order.getOrderItems().stream()
		            .map(item -> {
		                OrderItemResponse dto = new OrderItemResponse();
		                dto.setId(item.getId());
		                dto.setProductId(item.getProductId());
		                dto.setProductName(item.getProductName());
		                dto.setPrice(item.getPrice());
		                dto.setQuantity(item.getQuantity());
		                return dto;
		            }).collect(Collectors.toList());
		orderResponse.setOrderItem(itemResponses);
		return orderResponse;
	}
	public List<OrderResponse> get() {
		List<Order>order= orderRepository.findAll();
		return order.stream()
	            .map(this::mapToOrderResponse)
	            .collect(Collectors.toList());
	}

}
